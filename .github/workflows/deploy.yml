name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.4'
        cache: true

    - name: Build binary
      run: |
        go build -o bin/app cmd/main.go

    - name: Deploy to server
      run: |
        echo "Deploying to production..."
        
        # Подключение к серверу и выполнение команд
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /home/medblogers_base
          git pull 
          docker-compose up --build -d
        EOF
        
        echo "Deployment completed!"

    - name: Health check
      run: |
        echo "Performing health check..."
        # curl -f http://your-app-url/health || exit 1
        echo "Health check passed!"
